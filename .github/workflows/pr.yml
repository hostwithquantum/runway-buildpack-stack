name: PR

on:
  pull_request:

jobs:
  push:
    name: Push
    runs-on: ubuntu-22.04
    steps:

    - uses: actions/checkout@v5

    - uses: buildpacks/github-actions/setup-pack@main
      with:
        pack-version: 0.38.2

    - uses: docker/build-push-action@v6
      with:
        context: runimage
        cache-from: r.planetary-quantum.com/runway-public/runway-runimage:jammy-full
        push: false
        tags: runimage-test

    - name: Create Builder Unflattened
      run: make build-builder-unflattened

    - run: |
        LAYER_COUNT=$(docker image inspect builder-unflattened | jq '.[].RootFS.Layers | length')
        echo "## Layer Count (unflattened)" >> $GITHUB_STEP_SUMMARY
        echo "${LAYER_COUNT} layers" >> $GITHUB_STEP_SUMMARY

    - name: Show buildpacks to be flattened
      run: |
        echo "## Buildpacks to be flattened" >> $GITHUB_STEP_SUMMARY
        pack builder inspect \
          -o json \
          builder-unflattened \
        | jq -r '.local_info.buildpacks[] | "- " + .id + "@" + .version' >> $GITHUB_STEP_SUMMARY

    - name: Create Builder Image (flattened)
      run: make build-builder

    - shell: bash
      run: |
        LAYER_COUNT=$(docker image inspect runway-builder | jq '.[].RootFS.Layers | length')
        if [ "$LAYER_COUNT" -gt "100" ]; then
          echo "Too many layers: $LAYER_COUNT (limit: 100)"
          exit 1
        fi
        echo "## Layer Count (flattened)" >> $GITHUB_STEP_SUMMARY
        echo "${LAYER_COUNT} layers" >> $GITHUB_STEP_SUMMARY